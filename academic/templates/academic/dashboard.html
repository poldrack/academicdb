{% extends 'academic/base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Dashboard</h1>
        <p>Welcome to your academic database, {{ user.display_name }}!</p>
        
        <!-- Sync Status and Actions -->
        <div class="card bg-light mb-4">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-sync-alt"></i> Database Synchronization</h5>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        {% if user.is_orcid_connected %}
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span>ORCID: {{ user.orcid_id }}</span>
                            </div>
                        {% else %}
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-times-circle text-warning me-2"></i>
                                <span>ORCID: Not connected</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4">
                        {% if user.has_pubmed_query %}
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span>PubMed: Query configured</span>
                            </div>
                        {% else %}
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-times-circle text-warning me-2"></i>
                                <span>PubMed: No query set</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4">
                        {% if user.has_scopus_id %}
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span>Scopus: {{ user.scopus_id }}</span>
                            </div>
                        {% else %}
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-times-circle text-warning me-2"></i>
                                <span>Scopus: No ID set</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Sync Actions -->
                <div class="row">
                    <div class="col-md-8">
                        {% if user.is_orcid_connected or user.has_pubmed_query or user.has_scopus_id %}
                            <form method="post" action="{% url 'academic:comprehensive_sync' %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary btn-lg me-3" id="comprehensive-sync-btn">
                                    <i class="fas fa-sync-alt"></i> Sync All Databases
                                </button>
                            </form>
                            <small class="text-muted">
                                This will sync publications from all configured sources and enrich them with metadata.
                                {% if user.last_orcid_sync %}
                                    <br>Last sync: {{ user.last_orcid_sync|timesince }} ago
                                {% endif %}
                            </small>
                            
                            <!-- Progress Tracking Container (initially hidden) -->
                            <div id="sync-progress-container" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-sync-alt fa-spin me-2"></i>
                                        <strong id="sync-phase">Starting sync...</strong>
                                    </div>
                                    
                                    <div class="progress mb-2" style="height: 25px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             id="sync-progress-bar" role="progressbar" 
                                             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                            <span id="sync-progress-text">0%</span>
                                        </div>
                                    </div>
                                    
                                    <div id="sync-current-step" class="small text-muted">
                                        Initializing...
                                    </div>
                                    
                                    <!-- Progress Messages -->
                                    <div id="sync-messages" class="mt-2" style="display: none;">
                                        <ul class="list-unstyled small mb-0" id="sync-messages-list">
                                        </ul>
                                    </div>
                                    
                                    <!-- Success/Error Summary -->
                                    <div id="sync-summary" class="mt-2" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> 
                                No sync sources configured. <a href="{% url 'academic:profile' %}" class="alert-link">Set up your profile</a> 
                                to enable automatic database synchronization.
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4 text-end">
                        {% if user.publications.count > 0 %}
                            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#clearPublicationsModal">
                                <i class="fas fa-trash-alt"></i> Clear All Publications
                            </button>
                            <br><small class="text-muted">Remove all publications from database</small>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Individual Sync Options (collapsed by default) -->
                <div class="accordion mt-3" id="individualSyncAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#individualSyncOptions">
                                Individual Sync Options
                            </button>
                        </h2>
                        <div id="individualSyncOptions" class="accordion-collapse collapse" data-bs-parent="#individualSyncAccordion">
                            <div class="accordion-body">
                                <div class="btn-group-vertical d-grid gap-2">
                                    {% if user.is_orcid_connected %}
                                        <form method="post" action="{% url 'academic:orcid_sync' %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-outline-primary">
                                                <i class="fab fa-orcid"></i> Sync ORCID Only
                                            </button>
                                        </form>
                                    {% endif %}
                                    
                                    {% if user.has_pubmed_query %}
                                        <form method="post" action="{% url 'academic:pubmed_sync' %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-outline-success">
                                                <i class="fas fa-notes-medical"></i> Sync PubMed Only
                                            </button>
                                        </form>
                                    {% endif %}
                                    
                                    {% if user.has_scopus_id %}
                                        <form method="post" action="{% url 'academic:scopus_sync' %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-outline-info">
                                                <i class="fas fa-microscope"></i> Sync Scopus Only
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Publications</h5>
                <h2 class="text-primary">{{ user.publications.count|default:"0" }}</h2>
                <p class="card-text">Total publications in database</p>
                <a href="{% url 'academic:publication_list' %}" class="btn btn-primary">Manage Publications</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Collaborators</h5>
                <h2 class="text-success">0</h2>
                <p class="card-text">Unique coauthors</p>
                <a href="#" class="btn btn-success">View Network</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Funding</h5>
                <h2 class="text-info">{{ user.funding.count|default:"0" }}</h2>
                <p class="card-text">Grants and awards</p>
                <a href="{% url 'academic:funding_list' %}" class="btn btn-info">Manage Funding</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">CV Export</h5>
                <h2 class="text-warning">📄</h2>
                <p class="card-text">Generate CV</p>
                <a href="#" class="btn btn-warning">Export CV</a>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <h3>Recent Activity</h3>
        <div class="card">
            <div class="card-body">
                <p class="text-muted">No recent activity. Start by connecting your ORCID account or adding publications manually.</p>
            </div>
        </div>
    </div>
</div>

<!-- Clear Publications Confirmation Modal -->
<div class="modal fade" id="clearPublicationsModal" tabindex="-1" aria-labelledby="clearPublicationsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="clearPublicationsModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Clear All Publications
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>⚠️ Warning:</strong> This will permanently delete <strong>all {{ user.publications.count }} publications</strong> from your database.
                </div>
                
                <p><strong>This action cannot be undone.</strong> All publication data, including:</p>
                <ul>
                    <li>Publication metadata and abstracts</li>
                    <li>Author information and affiliations</li>
                    <li>Citation data and identifiers</li>
                    <li>Manual edits and customizations</li>
                </ul>
                <p>will be permanently removed from your account.</p>
                
                <p>You can re-sync publications from your external sources (ORCID, PubMed, Scopus) after clearing, but any manual edits will be lost.</p>
                
                <hr>
                
                <form method="post" action="{% url 'academic:clear_publications' %}" id="clearPublicationsForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="confirmationInput" class="form-label">
                            <strong>To confirm, type "delete all publications" exactly:</strong>
                        </label>
                        <input type="text" class="form-control" id="confirmationInput" name="confirmation" 
                               placeholder="Type here to confirm..." autocomplete="off">
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                            <i class="fas fa-trash-alt"></i> Delete All Publications
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let eventSource = null;
    
    // Handle comprehensive sync button
    const syncBtn = document.getElementById('comprehensive-sync-btn');
    const progressContainer = document.getElementById('sync-progress-container');
    
    if (syncBtn) {
        syncBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Show loading state
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
            
            // Submit form and start progress tracking
            const form = this.closest('form');
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                }
            })
            .then(response => response.text())
            .then(html => {
                // Parse the response to check if sync started successfully
                if (html.includes('Started comprehensive sync')) {
                    // Show progress container
                    progressContainer.style.display = 'block';
                    
                    // Start real-time progress monitoring
                    startProgressTracking();
                } else {
                    // Handle error or redirect
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error starting sync:', error);
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-sync-alt"></i> Sync All Databases';
                alert('Failed to start sync. Please try again.');
            });
        });
    }
    
    function startProgressTracking() {
        // Close any existing connection
        if (eventSource) {
            eventSource.close();
        }
        
        // Start Server-Sent Events connection
        eventSource = new EventSource('{% url "academic:sync_progress" %}');
        
        const progressBar = document.getElementById('sync-progress-bar');
        const progressText = document.getElementById('sync-progress-text');
        const phaseElement = document.getElementById('sync-phase');
        const currentStepElement = document.getElementById('sync-current-step');
        const messagesContainer = document.getElementById('sync-messages');
        const messagesList = document.getElementById('sync-messages-list');
        const summaryContainer = document.getElementById('sync-summary');
        
        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                
                if (data.error) {
                    console.error('Progress tracking error:', data.error);
                    return;
                }
                
                // Update progress bar
                const progress = Math.max(0, Math.min(100, data.progress || 0));
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                progressText.textContent = Math.round(progress) + '%';
                
                // Update phase and current step
                if (data.phase) {
                    phaseElement.textContent = data.phase;
                }
                if (data.current_step) {
                    currentStepElement.textContent = data.current_step;
                }
                
                // Show messages if available
                if (data.messages && data.messages.length > 0) {
                    messagesContainer.style.display = 'block';
                    messagesList.innerHTML = data.messages.map(msg => 
                        `<li><i class="fas fa-${msg.startsWith('✓') ? 'check text-success' : 'times text-danger'}"></i> ${msg}</li>`
                    ).join('');
                }
                
                // Handle completion
                if (data.status === 'completed') {
                    handleSyncComplete(data, false);
                } else if (data.status === 'completed_with_errors') {
                    handleSyncComplete(data, true);
                } else if (data.status === 'error') {
                    handleSyncError(data);
                }
                
            } catch (error) {
                console.error('Error parsing progress data:', error);
            }
        };
        
        eventSource.onerror = function(event) {
            console.error('EventSource error:', event);
            eventSource.close();
            
            // Fallback: show generic message and re-enable button after delay
            setTimeout(() => {
                if (syncBtn.disabled) {
                    syncBtn.disabled = false;
                    syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Sync All Databases';
                    progressContainer.style.display = 'none';
                }
            }, 5000);
        };
    }
    
    function handleSyncComplete(data, hasErrors) {
        const summaryContainer = document.getElementById('sync-summary');
        const progressContainer = document.getElementById('sync-progress-container');
        const alertElement = progressContainer.querySelector('.alert');
        
        // Close event source
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
        
        // Update UI to show completion
        const icon = progressContainer.querySelector('.fa-sync-alt');
        if (icon) {
            icon.classList.remove('fa-spin');
            icon.classList.add(hasErrors ? 'fa-exclamation-triangle' : 'fa-check');
        }
        
        // Change alert style
        alertElement.classList.remove('alert-info');
        alertElement.classList.add(hasErrors ? 'alert-warning' : 'alert-success');
        
        // Show summary
        let summaryHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${hasErrors ? 'Sync completed with warnings' : 'Sync completed successfully!'}</strong>
        `;
        
        if (data.publications_added !== undefined) {
            summaryHTML += `<br><small>Added ${data.publications_added} new publications</small>`;
        }
        
        summaryHTML += `
                </div>
                <div>
                    <button class="btn btn-sm btn-primary" onclick="window.location.reload()">
                        <i class="fas fa-redo"></i> Refresh
                    </button>
                </div>
            </div>
        `;
        
        if (data.errors && data.errors.length > 0) {
            summaryHTML += `
                <details class="mt-2">
                    <summary class="small text-muted">View errors (${data.errors.length})</summary>
                    <ul class="small mb-0 mt-1">
                        ${data.errors.map(error => `<li class="text-danger">${error}</li>`).join('')}
                    </ul>
                </details>
            `;
        }
        
        summaryContainer.innerHTML = summaryHTML;
        summaryContainer.style.display = 'block';
        
        // Re-enable sync button
        syncBtn.disabled = false;
        syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Sync All Databases';
        
        // Auto-refresh page after 5 seconds
        setTimeout(() => {
            window.location.reload();
        }, 5000);
    }
    
    function handleSyncError(data) {
        const summaryContainer = document.getElementById('sync-summary');
        const progressContainer = document.getElementById('sync-progress-container');
        const alertElement = progressContainer.querySelector('.alert');
        
        // Close event source
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
        
        // Update UI to show error
        const icon = progressContainer.querySelector('.fa-sync-alt');
        if (icon) {
            icon.classList.remove('fa-spin');
            icon.classList.add('fa-times');
        }
        
        // Change alert style
        alertElement.classList.remove('alert-info');
        alertElement.classList.add('alert-danger');
        
        // Show error summary
        summaryContainer.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>Sync failed</strong>
                    <br><small>${data.current_step || 'An error occurred during synchronization'}</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-secondary" onclick="window.location.reload()">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                </div>
            </div>
        `;
        summaryContainer.style.display = 'block';
        
        // Re-enable sync button
        syncBtn.disabled = false;
        syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Sync All Databases';
    }
    
    // Check for active sync on page load
    function checkActiveSync() {
        fetch('{% url "academic:sync_status" %}')
            .then(response => response.json())
            .then(data => {
                if (data.active_sync && data.active_sync.status in ['starting', 'running']) {
                    // Show progress container and start tracking
                    progressContainer.style.display = 'block';
                    syncBtn.disabled = true;
                    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
                    startProgressTracking();
                }
            })
            .catch(error => console.log('Sync status check failed:', error));
    }
    
    // Check for active sync on page load
    checkActiveSync();
    
    // Handle individual sync buttons
    const individualSyncBtns = document.querySelectorAll('button[type="submit"]:not(#comprehensive-sync-btn)');
    individualSyncBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            // Update UI immediately
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
            
            // Don't disable the button - let the form submit
            // The button will be disabled by the form submission
            
            // Re-enable after a delay if something goes wrong
            setTimeout(() => {
                if (this.innerHTML.includes('Syncing')) {
                    this.disabled = false;
                    this.innerHTML = originalText;
                }
            }, 30000); // 30 seconds timeout
        });
    });
    
    // Auto-refresh sync status (optional)
    function refreshSyncStatus() {
        fetch('{% url "academic:sync_status" %}')
            .then(response => response.json())
            .then(data => {
                // Update publication count if it changed
                const pubCountElement = document.querySelector('.text-primary h2');
                if (pubCountElement && data.publication_count !== undefined) {
                    pubCountElement.textContent = data.publication_count;
                }
                
                // Update last sync time if available
                if (data.last_sync) {
                    const lastSyncElement = document.querySelector('.text-muted small');
                    if (lastSyncElement) {
                        const lastSyncDate = new Date(data.last_sync);
                        const now = new Date();
                        const timeDiff = Math.floor((now - lastSyncDate) / 1000 / 60); // minutes ago
                        
                        let timeAgoText = '';
                        if (timeDiff < 1) {
                            timeAgoText = 'just now';
                        } else if (timeDiff < 60) {
                            timeAgoText = `${timeDiff} minute${timeDiff === 1 ? '' : 's'} ago`;
                        } else {
                            const hours = Math.floor(timeDiff / 60);
                            timeAgoText = `${hours} hour${hours === 1 ? '' : 's'} ago`;
                        }
                        
                        lastSyncElement.innerHTML = lastSyncElement.innerHTML.replace(
                            /Last sync: [^<]*/,
                            `Last sync: ${timeAgoText}`
                        );
                    }
                }
            })
            .catch(error => console.log('Sync status update failed:', error));
    }
    
    // Refresh sync status every 30 seconds
    setInterval(refreshSyncStatus, 30000);
    
    // Handle clear publications confirmation
    const confirmationInput = document.getElementById('confirmationInput');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const clearPublicationsForm = document.getElementById('clearPublicationsForm');
    
    if (confirmationInput && confirmDeleteBtn) {
        confirmationInput.addEventListener('input', function() {
            const expectedText = 'delete all publications';
            const inputText = this.value.toLowerCase().trim();
            
            if (inputText === expectedText) {
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.classList.remove('disabled');
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                confirmDeleteBtn.disabled = true;
                confirmDeleteBtn.classList.add('disabled');
                this.classList.remove('is-valid');
                if (inputText.length > 0) {
                    this.classList.add('is-invalid');
                }
            }
        });
        
        // Handle form submission
        clearPublicationsForm.addEventListener('submit', function(e) {
            const inputText = confirmationInput.value.toLowerCase().trim();
            if (inputText !== 'delete all publications') {
                e.preventDefault();
                confirmationInput.classList.add('is-invalid');
                return false;
            }
            
            // Show loading state
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        });
        
        // Reset form when modal is hidden
        const clearModal = document.getElementById('clearPublicationsModal');
        clearModal.addEventListener('hidden.bs.modal', function() {
            confirmationInput.value = '';
            confirmationInput.classList.remove('is-valid', 'is-invalid');
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.classList.add('disabled');
            confirmDeleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete All Publications';
        });
    }
});
</script>
{% endblock %}